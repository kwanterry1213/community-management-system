import os
from crewai import Agent, Task, Crew, Process, LLM
# âœ… é€™æ˜¯æ–°ç‰ˆå¯«æ³•ï¼Œå¿…é ˆå®‰è£ crewai-tools
from crewai_tools import FileReadTool

# ==============================================
# ğŸ”‘ è¨­å®š OpenRouter API Key (è«‹å¡«å…¥ä½ çš„ Key)
# ==============================================
OPENROUTER_API_KEY = "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" # <--- è«‹åœ¨æ­¤è™•è²¼ä¸Šä½ çš„ API Key
os.environ["OPENROUTER_API_KEY"] = OPENROUTER_API_KEY

# å®šç¾©å¤§è…¦ (ä½¿ç”¨ DeepSeek)
himac_llm = LLM(
    model="openrouter/deepseek/deepseek-chat", 
    api_key=OPENROUTER_API_KEY
)

# ==============================================
# ğŸ› ï¸ å®šç¾©å·¥å…·ï¼šè®“ AI æœ‰çœ¼ç›çœ‹æª”æ¡ˆ
# ==============================================
# é€™å€‹å·¥å…·è®“ AI å¯ä»¥è®€å–ä½ é›»è…¦è£¡çš„ app.py, ui.py ç­‰æª”æ¡ˆ
file_read_tool = FileReadTool()

# ==============================================
# 1. å®šç¾©è§’è‰²ï¼šç¶­è­·åœ˜éšŠ
# ==============================================

# è§’è‰²ï¼šæŠ€è¡“ç¸½ç›£ (è² è²¬ç†è§£ä½ çš„å ±éŒ¯ï¼Œä¸¦æª¢æŸ¥ç¾æœ‰ä»£ç¢¼)
tech_lead = Agent(
    role='Himac æŠ€è¡“ç¸½ç›£ (Tech Lead)',
    goal='åˆ†æç”¨æˆ¶åé¥‹èˆ‡ç¾æœ‰ä»£ç¢¼ï¼Œåˆ¶å®šç²¾ç¢ºçš„ä¿®æ”¹è¨ˆåŠƒ',
    backstory="""ä½ æ˜¯ç¶“é©—è±å¯Œçš„ Python æŠ€è¡“ç®¡ç†è€…ã€‚
    ä½ çš„å°ˆé•·æ˜¯ Debugging (é™¤éŒ¯) å’Œ Code Review (ä»£ç¢¼å¯©æŸ¥)ã€‚
    ä½ éå¸¸è¬¹æ…ï¼Œåœ¨ä¿®æ”¹ä»£ç¢¼å‰ï¼Œä¸€å®šæœƒå…ˆé–±è®€ç¾æœ‰çš„æª”æ¡ˆå…§å®¹ï¼Œ
    ç¢ºä¿ä¸æœƒç ´å£åŸæœ¬æ­£å¸¸é‹ä½œçš„åŠŸèƒ½ã€‚
    """,
    verbose=True,
    allow_delegation=True,
    tools=[file_read_tool], # è³¦äºˆè®€æª”æ¬Šé™
    llm=himac_llm
)

# è§’è‰²ï¼šç¶­è­·å·¥ç¨‹å¸« (è² è²¬å‹•æ‰‹æ”¹)
maintenance_engineer = Agent(
    role='è³‡æ·±ç¶­è­·å·¥ç¨‹å¸« (Maintenance Engineer)',
    goal='æ ¹æ“šç¸½ç›£çš„æŒ‡ç¤ºï¼Œé‡å¯«ä¸¦è¼¸å‡ºå®Œæ•´çš„ä»£ç¢¼æª”æ¡ˆ',
    backstory="""ä½ æ˜¯åŸ·è¡ŒåŠ›æ¥µå¼·çš„å·¥ç¨‹å¸«ã€‚
    ä½ çš„å·¥ä½œæ˜¯æ ¹æ“šä¿®æ”¹è¨ˆç•«ï¼Œè¼¸å‡ºã€Œå¯ç›´æ¥åŸ·è¡Œã€çš„å®Œæ•´ Python ä»£ç¢¼ã€‚
    ä½ åš´æ ¼éµå®ˆä»¥ä¸‹åŸå‰‡ï¼š
    1. è¼¸å‡ºå®Œæ•´çš„æª”æ¡ˆå…§å®¹ï¼Œä¸è¦åªçµ¦ç‰‡æ®µã€‚
    2. ç¢ºä¿ä¿®å¾©äº† Bug æˆ–å®Œæˆäº†æ–°åŠŸèƒ½ã€‚
    3. ä¿æŒä»£ç¢¼æ•´æ½”ï¼ŒåŠ ä¸Šå¿…è¦çš„è¨»è§£ã€‚
    """,
    verbose=True,
    allow_delegation=False,
    tools=[file_read_tool],
    llm=himac_llm
)

# ==============================================
# 2. å®šç¾©ä»»å‹™æµç¨‹
# ==============================================
def create_fix_tasks(feedback, target_file):
    
    # ä»»å‹™ 1: è¨ºæ–· (ç”± Tech Lead åŸ·è¡Œ)
    task_diagnose = Task(
        description=f"""
        è€é—† (ç”¨æˆ¶) é‡å°æª”æ¡ˆ '{target_file}' æå‡ºäº†ä»¥ä¸‹åé¥‹ï¼š
        "{feedback}"
        
        ä½ çš„å·¥ä½œï¼š
        1. ä½¿ç”¨ FileReadTool è®€å– '{target_file}' çš„å®Œæ•´å…§å®¹ã€‚
        2. åˆ†æä»£ç¢¼é‚è¼¯ï¼Œæ‰¾å‡ºå•é¡Œæ‰€åœ¨ã€‚
        3. å¦‚æœæ˜¯æ–°å¢åŠŸèƒ½ï¼Œæ€è€ƒæ‡‰è©²æ’åœ¨å“ªå€‹ä½ç½®æœ€åˆé©ã€‚
        4. å¦‚æœæ˜¯åˆªé™¤åŠŸèƒ½ï¼Œç¢ºèªæ˜¯å¦æœ‰ç›¸ä¾æ€§éœ€è¦ä¸€ä½µæ¸…ç†ã€‚
        
        è«‹ç”¢å‡ºä¸€ä»½ã€Œä¿®æ”¹è¨ˆç•«ã€ï¼Œæ˜ç¢ºæŒ‡å‡ºè¦æ”¹å“ªå¹¾è¡Œã€é‚è¼¯å¦‚ä½•è®Šæ›´ã€‚
        """,
        expected_output='ä¸€ä»½è©³ç´°çš„ä»£ç¢¼ä¿®æ”¹è¨ˆç•« (Step-by-step plan).',
        agent=tech_lead,
        tools=[file_read_tool]
    )

    # ä»»å‹™ 2: ä¿®å¾© (ç”± Engineer åŸ·è¡Œ)
    task_fix = Task(
        description=f"""
        æ ¹æ“šæŠ€è¡“ç¸½ç›£çš„ä¿®æ”¹è¨ˆç•«ï¼Œé‡å¯« '{target_file}'ã€‚
        
        âš ï¸ éå¸¸é‡è¦ï¼š
        1. ä½ å¿…é ˆè¼¸å‡ºè©²æª”æ¡ˆçš„ **å®Œæ•´åŸå§‹ç¢¼ (Full Source Code)**ã€‚
        2. è«‹ç”¨ Markdown Code Block åŒ…è£¹ä»£ç¢¼ (ä¾‹å¦‚ ```python ... ```)ã€‚
        3. ä¸è¦ä½¿ç”¨çœç•¥è™Ÿ (...)ï¼Œè€é—†éœ€è¦ç›´æ¥è¤‡è£½è²¼ä¸Šã€‚
        """,
        expected_output=f'ä¿®æ”¹å¾Œå®Œæ•´çš„ {target_file} ä»£ç¢¼ã€‚',
        agent=maintenance_engineer,
        context=[task_diagnose] # åƒè€ƒä¸Šä¸€å€‹ä»»å‹™çš„çµæœ
    )
    
    return [task_diagnose, task_fix]

# ==============================================
# 3. å•Ÿå‹•ç¶­è­·ç¸½éƒ¨
# ==============================================
if __name__ == "__main__":
    print("\n================================================")
    print("ğŸš‘ Himac AI ç¶­è­·åœ˜éšŠ (Bug Fix & Refactor) å·²å°±ä½")
    print("================================================\n")
    
    # 1. å•è€é—†è¦æ”¹å“ªå€‹æª”æ¡ˆ
    target_file = input("è€é—†ï¼Œè«‹å•è¦ä¿®æ”¹å“ªå€‹æª”æ¡ˆ (ä¾‹å¦‚ app.py æˆ– ui.py): ")
    
    # 2. å•è€é—†å“ªè£¡å£äº†
    print(f"\nè«‹æè¿°å° {target_file} çš„ä¿®æ”¹éœ€æ±‚ (ä¾‹å¦‚: 'ä¿®å¾©åŠ ç­è¨ˆç®—éŒ¯èª¤' æˆ– 'åˆªé™¤æŸå€‹æŒ‰éˆ•'):")
    user_feedback = input("> ")
    
    # å»ºç«‹åœ˜éšŠèˆ‡æµç¨‹
    crew = Crew(
        agents=[tech_lead, maintenance_engineer],
        tasks=create_fix_tasks(user_feedback, target_file),
        process=Process.sequential,
        verbose=True
    )

    print(f"\nâš™ï¸ åœ˜éšŠæ­£åœ¨åˆ†æ {target_file}ï¼Œè«‹ç¨å€™...\n")
    result = crew.kickoff()
    
    print("\n\n################################################")
    print("## âœ… ç¶­è­·å®Œæˆï¼è«‹è¤‡è£½ä¸‹æ–¹ä»£ç¢¼æ›´æ–°æª”æ¡ˆ ##")
    print("################################################\n")
    print(result)